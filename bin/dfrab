#!/usr/bin/env bash

CURRENT_DFRAB_PROFILE=$(readlink ~/.dfrab/current)


if [[ "$1" == 'init' ]] ; then
  if [[ ! -d ~/.dfrab/backups/start ]] ; then
    mkdir -p ~/.dfrab
    mkdir -p ~/.dfrab/backups
    mkdir -p ~/.dfrab/current
    mkdir -p ~/.dfrab/
    mkdir -p ~/.dfrab/backups/start
    ln -s ~/.dfrab/backups/start ~/.dfrab/current
    mv ~/.config ~/.dfrab/current/.config
    ln -s ~/.dfrab/current/.config ~/.config
    exit 0
  fi
fi

if [[ "$1" == 'link' ]] ; then
  mv ~/$2 ~/.dfrab/current
  ln -s ~/.drab/$2 ~/$2
  exit 0
fi

if [[ "$1" == 'switch-profile' ]] ; then
  if [[ ! -d ~/.dfrab/backups/$2 ]]
    ln -sf ~/.dfrab/backups/$2 ~/.dfrab/current
    exit 0
  fi
fi

if [[ "$1" == 'create-profile' ]] ; then
  if [[ -d ~/.dfrab/backups/$2 ]] ; then
    echo "$2 already exists, use a different name."
    exit 21
  fi
  if [[ ! -d ~/.dfrab/backups/$2 ]] ; then
    mkdir ~/.dfrab/backups/$2
    mv ~/.dfrab/current/* ~/.dfrab/backups/$2
    ln -sf ~/.dfrab/backups/$2 ~/.dfrab/current
    exit 0
  fi
fi
    
if [[ "$1" == 'create-backup' ]] ; then
  if [[ -d ~/.dfrab/backups/$2 ]]
    echo "$2 already exists, use a different name."
    exit 21
  fi
  if [[ ! -d ~/.dfrab/backups/$2 ]] ; then
    mkdir -p ~/.dfrab/backups/$2
    cp -r ~/.dfrab/current/* ~/.dfrab/backups/$2
    exit 0
  fi
fi

if [[ "$1" == 'remove-backup' ]] ; then
  if [[ ! -d ~/.dfrab/backups/$2 ]] ; then
    echo "$2 does not exist"
    exit 21
  fi
  if [[ -d $CURRENT_DFRAB_PROFILE ]]
    echo "Can't delete because it is currently in use"
    exit 1
  if [[ -d ~/.dfrab/backups/$2 ]] ; then
    rm -r ~/.dfrab/backups/$2
    exit 0
  fi
fi

if [[ "$1" == 'unlink' ]] ; then
  rm ~/$2
  mv ~/.dfrab/current/$2 ~/$2
  exit 0
fi
