#!/usr/bin/env bash

CURRENT_DFRAB_PROFILE=$(readlink ~/.dfrab/current)


if [[ "$1" == 'init' ]] ; then
  if [[ ! -f ~/.dfrab/config/inited.conf ]] ; then
    mkdir -p ~/.dfrab
    mkdir -p ~/.dfrab/backups
    mkdir -p ~/.dfrab/config
    mkdir -p ~/.dfrab/backups/start
    ln -s ~/.dfrab/backups/start ~/.dfrab/current
    touch ~/.dfrab/config/inited.conf
    exit 0
  fi
  if [[ -f ~/.dfrab/config/inited.conf ]] ; then
    echo "dfrab has already been inited."
    exit 1
  fi
fi

if [[ "$1" == 'link' ]] ; then
  if [[ "$2" == '.dfrab' ]] ; then
    echo "Fatal: unable to link .dfrab"
    exit 1
  fi
  if [[ -L "$2" ]]; then
    echo "dfrab can't link symlinks"
    exit 1
  fi
  mv $2 ~/.dfrab/current
  ln -s ~/.dfrab/current/$2 $2
  exit 0
fi

if [[ "$1" == 'switch-profile' ]] ; then
  if [[ ! -d ~/.dfrab/backups/$2 ]] ; then
    ln -sf ~/.dfrab/backups/$2 ~/.dfrab/current
    exit 0
  fi
fi

if [[ "$1" == 'create-profile' ]] ; then
  if [[ -d ~/.dfrab/backups/$2 ]] ; then
    echo "$2 already exists, use a different name."
    exit 21
  fi
  if [[ ! -d ~/.dfrab/backups/$2 ]] ; then
    cp -r $CURRENT_DFRAB_PROFILE ~/.dfrab/backups/$2
    ln -sf ~/.dfrab/backups/$2 ~/.dfrab/current
    exit 0
  fi
fi
    
if [[ "$1" == 'create-backup' ]] ; then
  if [[ -d ~/.dfrab/backups/$2 ]] ; then
    echo "$2 already exists, use a different name."
    exit 21
  fi
  if [[ ! -d ~/.dfrab/backups/$2 ]] ; then
    cp -r $CURRENT_DFRAB_PROFILE ~/.dfrab/backups/$2
    exit 0
  fi
fi

if [[ "$1" == 'remove-backup' ]] ; then
  if [[ ! -d ~/.dfrab/backups/$2 ]] ; then
    echo "$2 does not exist"
    exit 21
  fi
  if [[ -d $CURRENT_DFRAB_PROFILE ]] ; then
    echo "Can't delete because it is currently in use"
    exit 1
  fi
  if [[ -d ~/.dfrab/backups/$2 ]] ; then
    rm -r ~/.dfrab/backups/$2
    exit 0
  fi
fi

if [[ "$1" == 'unlink' ]] ; then
  if [[ ! -e ~/.dfrab/current/$2 ]] ; then
    echo "Can't unlink non existing file"
    exit 1
  fi
  if [[ -L "$2" ]] ; then
    rm $2
    mv ~/.dfrab/current/$2 $2
    exit 0
  fi
  if [[ ! L "$2" ]] ; then
    echo "This is not a link"
    exit 0
  fi
fi

if [[ "$1" == 'list-backups' ]] ; then
  ls ~/.dfrab/backups
  exit 0
fi

if [[ "$1" == 'list-contents' ]] ; then
  ls ~/.dfarb/current
  exit 0
fi
  

if [[ "$1" == 'help' ]] ; then
  echo "init: sets up dfrab"
  echo "link: makes symlink of the dotfile while dfrab manages it"
  echo "switch-profile: switches to a different profile/backup"
  echo "create-profile: makes a new profile and switches to it"
  echo "create-backup: creates a new profile but doesn't switch to it"
  echo "remove-backup: deletes a backup/profile"
  echo "unlink: removes link and moves dotfile and makes it like dfrab has never touched it"
  echo "list-backups: lists backup directories"
  echo "list-contents: lists the contents in ~/.dfarb/current"
  exit 0
fi

echo "No arguments have been provided or the arguments are incorrect. Type help for command help"

exit 22
